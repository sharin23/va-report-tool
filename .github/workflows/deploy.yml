name: Flask CI/CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, Ubuntu24]

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Deploy to VM
      env:
        VM_USER: vauser
        VM_HOST: 10.0.2.15
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh -o StrictHostKeyChecking=no $VM_USER@$VM_HOST "
          cd ~/projects/va-report-tool &&
          git pull &&
          sudo systemctl restart flaskapp.service
        "
